#!/bin/bash

hosts=( c11node9 c11node10 )

#cmd="ps -ef | grep qemu | awk '{print \$10,\$14,\$15,\$16,\$17,\$19,\$20,\$21,\$23}' | egrep 'slave|master|tomcat|jboss|mysql'"
#cmd="ps -ef | grep qemu | awk '{print \$10}' | egrep 'slave|master|tomcat|jboss|mysql'"

# VM names
cmd="ps -ef | grep qemu | grep -v grep | awk '{print \$10}'"
# memory used
cmd2="free -m | head -2 | tail -1"

echo -e "Node \t                 total       used       free     shared    buffers     cached"

for host in ${hosts[@]}
do
	# list the VM names running on the host
	vmstr=`ssh $host $cmd`
	#echo $vmstr

	# convert the string into an array
	vms=($vmstr)	
	#echo ${#vms[@]}vms

	# display the host name with the number of VMs running on it
	echo -n "$host (${#vms[@]}vms) "

	qlist=`ssh $host ps -ef | grep qemu`
	#echo "$qlist"
	i=1
	
	# memory usage of the host
	ssh $host "$cmd2"

	# obtain the list of VMs runing on the host
	vmstr=`ssh $host $cmd | while read vm 
	do 
		vms[$i]=$vm
		echo $vm
	#	echo vm$i: $vm ${vms[$i]}
		i=$(( i + 1 ))
		#ssh "$vm; $cmd2"
	#	echo ${vms[@]}
	done`

	#echo ${#vms[*]}

	#echo ${vms[@]}

	# retrieve the memory usage of each VM using ssh
	i=1
	for vm in ${vms[@]}
#	for vm in ${vms[*]}
	do
		# file=/var/lib/libvirt/images/nfs/c11node9/slave6.qcow2
                if [[ $vm == *qcow2* ]]; then
                        #echo qcow2
                        vm=${vm%.qcow2}
                        #echo $vm
                        vm=${vm##*/}
                        #echo $vm
                fi

		echo -n "vm$i: $vm "
		ssh $vm $cmd2
		i=$(( i + 1 ))
	done

	#ps -ef | grep qemu | awk '{print $10,$12,$13,$14,$15,$17,$18,$19}' | egrep 'slave|master|tomcat|jboss|mysql'
	#ps -ef | grep qemu -n

	# grep name or image name
	vmnames=`ssh $host ps -ef | grep qemu`
	#echo "$qlist"
	#ssh c11node10 $cmd
	echo
done

